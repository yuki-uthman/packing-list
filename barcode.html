<!DOCTYPE html
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Label Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white p-6">
  <div class="mx-auto max-w-4xl">
    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Barcode Label Generator</h1>
    <p class="text-slate-600 mt-1">
      Enter SKU, product name, and price. The app will generate a barcode and lay out your label with SKU under the code, then name on one line and price below.
    </p>

    <div class="grid md:grid-cols-3 gap-4 mt-6">
      <div class="md:col-span-2">
        <div class="grid sm:grid-cols-3 gap-3">
          <div class="flex flex-col">
            <label class="text-sm font-medium text-slate-700">SKU</label>
            <input id="sku" placeholder="e.g. ABC12345"
              class="mt-1 h-11 rounded-2xl border border-slate-300 px-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
          </div>
          <div class="flex flex-col">
            <label class="text-sm font-medium text-slate-700">Product name</label>
            <input id="name" placeholder="e.g. Classic Mug"
              class="mt-1 h-11 rounded-2xl border border-slate-300 px-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
          </div>
          <div class="flex flex-col">
            <label class="text-sm font-medium text-slate-700">Price</label>
            <input id="price" placeholder="e.g. 12.99"
              class="mt-1 h-11 rounded-2xl border border-slate-300 px-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400" />
          </div>
        </div>

        <div class="flex gap-3 mt-4">
          <button type="button" onclick="clearForm()"
            class="h-11 px-4 rounded-2xl bg-slate-100 hover:bg-slate-200 text-slate-800 font-medium shadow-sm">
            Clear
          </button>
          <button type="button" onclick="printLabel()"
            class="h-11 px-4 rounded-2xl bg-black text-white hover:opacity-90 font-medium shadow">
            Print label
          </button>
        </div>
      </div>

      <!-- Live preview -->
      <div>
        <div class="rounded-2xl border-2 border-dashed border-slate-300 p-4">
          <div id="label" class="mx-auto rounded-xl border border-black bg-white flex flex-col justify-between p-1"
               style="width:3cm; height:2.5cm; box-sizing:border-box;">
            <svg id="barcode" class="w-full" style="height:18px;"></svg>
            <div id="skuText" class="sku text-[3.5mm] text-center mt-[1mm] tracking-wide"></div>
            <div id="nameText" class="name font-semibold text-[4mm]"></div>
            <div id="priceText" class="price font-bold text-[4mm]"></div>
          </div>
        </div>
        <p class="text-xs text-slate-500 mt-2">
          Layout: barcode with SKU directly below, then name on one line, and price on the next line with MVR prefix.
        </p>
      </div>
    </div>
  </div>

  <script>
    const skuInput = document.getElementById("sku");
    const nameInput = document.getElementById("name");
    const priceInput = document.getElementById("price");
    const barcode = document.getElementById("barcode");
    const skuText = document.getElementById("skuText");
    const nameText = document.getElementById("nameText");
    const priceText = document.getElementById("priceText");

    function updateLabel() {
      const sku = skuInput.value.trim();
      const name = nameInput.value.trim();
      const price = priceInput.value.trim();

      if (sku) {
        JsBarcode(barcode, sku, {
          format: "CODE128",
          displayValue: false,
          height: 18,
          width: 1.2,
          margin: 0,
        });
        skuText.textContent = sku;
      } else {
        barcode.innerHTML = "";
        skuText.textContent = "";
      }

      nameText.textContent = name;
      priceText.textContent = price ? `MVR ${parseFloat(price).toFixed(2)}` : "";
    }

    function clearForm() {
      skuInput.value = "";
      nameInput.value = "";
      priceInput.value = "";
      updateLabel();
    }

    function printLabel() {
      const node = document.getElementById("label");
      
      // Create a temporary div to render the label at the correct size
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.style.top = '-9999px';
      tempDiv.style.width = '300mm';
      tempDiv.style.height = '250mm';
      tempDiv.style.border = '1px solid #000';
      tempDiv.style.padding = '3mm';
      tempDiv.style.boxSizing = 'border-box';
      tempDiv.style.display = 'flex';
      tempDiv.style.flexDirection = 'column';
      tempDiv.style.justifyContent = 'center';
      tempDiv.style.alignItems = 'center';
      tempDiv.style.backgroundColor = 'white';
      tempDiv.style.fontFamily = 'Arial, sans-serif';
      
      // Clone the label content
      const labelClone = node.cloneNode(true);
      labelClone.style.width = '100%';
      labelClone.style.height = 'auto';
      labelClone.style.border = 'none';
      labelClone.style.padding = '0';
      labelClone.style.display = 'flex';
      labelClone.style.flexDirection = 'column';
      labelClone.style.justifyContent = 'center';
      labelClone.style.alignItems = 'stretch';
      labelClone.style.gap = '4mm';
      
      // Scale the barcode SVG
      const barcodeSvg = labelClone.querySelector('svg');
      if (barcodeSvg) {
        barcodeSvg.style.width = '100%';
        barcodeSvg.style.height = '45mm';
        barcodeSvg.style.flexShrink = '0';
      }
      
      // Scale text elements to match preview
      const skuElement = labelClone.querySelector('.sku');
      if (skuElement) {
        skuElement.style.fontSize = '20mm';
        skuElement.style.margin = '0';
        skuElement.style.textAlign = 'center';
        skuElement.style.letterSpacing = '1.5mm';
        skuElement.style.lineHeight = '1';
        skuElement.style.height = 'auto';
      }
      
      const nameElement = labelClone.querySelector('.name');
      if (nameElement) {
        nameElement.style.fontSize = '50mm';
        nameElement.style.fontWeight = 'bold';
        nameElement.style.margin = '0';
        nameElement.style.textAlign = 'center';
        nameElement.style.lineHeight = '1';
        nameElement.style.height = 'auto';
      }

      const priceElement = labelClone.querySelector('.price');
      if (priceElement) {
        priceElement.style.fontSize = '50mm';
        priceElement.style.fontWeight = 'bold';
        priceElement.style.margin = '0';
        priceElement.style.textAlign = 'center';
        priceElement.style.lineHeight = '1';
        priceElement.style.height = 'auto';
      }

      tempDiv.appendChild(labelClone);
      document.body.appendChild(tempDiv);
      
      // Convert to canvas first, then to PDF
      html2canvas(tempDiv, {
        width: 300 * 3.78, // 300mm in pixels
        height: 250 * 3.78, // 250mm in pixels
        scale: 2, // Higher scale for better quality
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      }).then(canvas => {
        // Create PDF with the specified dimensions
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: [300, 250] // Custom format matching our dimensions
        });
        
        // Convert canvas to image data
        const imgData = canvas.toDataURL('image/png');
        
        // Add the image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, 300, 250);
        
        // Generate filename with current date/time
        const now = new Date();
        const timestamp = now.getFullYear() + 
                         String(now.getMonth() + 1).padStart(2, '0') + 
                         String(now.getDate()).padStart(2, '0') + '_' +
                         String(now.getHours()).padStart(2, '0') + 
                         String(now.getMinutes()).padStart(2, '0');
        
        const sku = document.getElementById('sku').value.trim() || 'label';
        const filename = `barcode_${sku}_${timestamp}.pdf`;
        
        // Open PDF in new tab
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        const newWindow = window.open();
        newWindow.document.write(`
          <html>
            <head>
              <title>Barcode Label PDF</title>
              <style>
                body { 
                  margin: 0; 
                  padding: 20px; 
                  background: #f0f0f0; 
                  font-family: Arial, sans-serif; 
                  text-align: center;
                }
                .container { 
                  max-width: 800px; 
                  margin: 0 auto; 
                  background: white; 
                  padding: 20px;
                  border-radius: 8px; 
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                .pdf-info {
                  margin-bottom: 20px;
                  padding: 15px;
                  background: #f8f9fa;
                  border-radius: 5px;
                  border-left: 4px solid #007bff;
                }
                .btn { 
                  display: inline-block;
                  margin: 5px;
                  padding: 10px 20px; 
                  background: #007bff; 
                  color: white; 
                  text-decoration: none;
                  border-radius: 5px; 
                  cursor: pointer;
                  border: none;
                  font-size: 14px;
                }
                .btn:hover { background: #0056b3; }
                .btn-secondary { background: #6c757d; }
                .btn-secondary:hover { background: #545b62; }
                .btn-success { background: #28a745; }
                .btn-success:hover { background: #1e7e34; }
                iframe {
                  width: 100%;
                  height: 500px;
                  border: 1px solid #ddd;
                  border-radius: 5px;
                  margin-top: 20px;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <iframe src="${pdfUrl}"></iframe>
              </div>
            </body>
          </html>
        `);
        newWindow.document.close();
      }).catch(error => {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      });
      
      // Clean up
      document.body.removeChild(tempDiv);
    }

    skuInput.addEventListener("input", updateLabel);
    nameInput.addEventListener("input", updateLabel);
    priceInput.addEventListener("input", updateLabel);
  </script>
</body>
</html>

